%!TEX root = /Users/zolkko/Projects/zolkko-alarm/doc/main.tex
\section{Реализация программно-аппаратного универсальной
системы терморегулирования на базе микроконтроллера AVR семейства XMega}
В качестве объекта исследования в ходе выполнения дипломного проектирования мной
была спроектирован и частично реализован программно-аппаратный комплекс
универсального терморегулирования.

Одной из возможных областей применения такого рода комплексов является дистанционное
автоматизированное управление коптильными камерами, используемыми при изготовлении
колбасных изделий фабрик пищевой промышленности.

\subsection{Описание структурной схемы универсальной системы терморегулирования}
Структурная схема универсальной системы терморегулирования на базе микроконтроллера
AVR семейства XMega приведена в приложении A.

Функциональным назначением представленных на схеме блоков является:
\begin{enumerate}
	\item{} Управляющее устройство -- устройство устанавливаемое непосредственно
	на объект управления. Выполняет следующие функции:
		\begin{itemize}
			\item{} ОУ -- считывание показаний термопар и усиление их сигнала;
			\item{} устройство индикации -- выводтинформацию о текущем состоянии системы;
			\item{} память -- сранит настройки системы и список технологических процессов для
				исполнения;
			\item{} звуковая сигнализация -- выполняет оповещение звуковым сигналом о
				наступлении события завершения текущей операции или о том, что произошла ошибка;
			\item{} устройство ввода -- обеспечивает функцию задания операции на исполнение,
				остановку операции исполнения;
			\item{} датчик температуры -- получение температур холодного спая термопары;
			\item{} блок ШИМ управления -- формирует управляющий сигнал, воздействующий на
				тепло-электро нагреватель;
			\item{} сетевой интерфейс -- обеспечивает функцию передачи и приёма данных
				через сеть Ethernet 802.3;
			\item{} центральный процессов -- модуль обеспечивающий взаимодействие компонентов
				управляющего устройства, направленное на исполнение заданного технологического
				процесса.
		\end{itemize}
	\item{} Контролирующий сервис -- обеспечивает:
	 	\begin{itemize}
			\item{} авторизацию устройства управления;
			\item{} сбор и хранение показаний датчиков управляющего устройства;
			\item{} интерфейс пользователя контролирующей системы.
		\end{itemize}
	\item{} Объект управления -- объект, управление и контроль состояния которого необходимо проводить
		в данном технологическом процессе.
\end{enumerate}


\subsection{Детализация компонентов универсальной системы терморегулирования}


\subsection{Анализ динамики работы системы}
В процессе разработки любой системы крайне важным шагом является проведение анализа динамики
работы разрабатываемой системы.
В качестве инструмента анализа динамики программных систем часто используются диаграммы последовательности (рис. \ref{img:dynamic}),
так как они являются удобным средством для обозначения очерёдности следования сообщений от одного объекта к другому во времени.
\begin{figure}[h]
	\center{\includegraphics[bb=0 0 250 250, clip, scale=1.5]{system_dynamic.png}}
	\caption{Диаграмма динамики системы}
	\label{img:dynamic}
\end{figure}
Главный акцент диаграммы последовательности -- порядок и динамика поведения, то есть как и в каком порядке происходят события.

\subsection{Разработка контролирующего сервиса}
Из представленной диаграммы динамики работы системы (рис. \ref{img:dynamic}), видно,
что контролирующий сервис выполняет обработку исключительно коротких запросов. Однако, количество таких
запросов довольно большое.

Применение сервисов выделяющих на обработку каждого запроса отдельного потока может привести к
ситуации, когда политика операционной системы заблокирует выделение дополнительного потока сервису,
или постоянное переключение между выполняющимися равнозначными потоками приводит к значительным задержкам
в обработке одного запроса, из-за больших накладных расходов на переключение контекстов операционной системы.

В случае использования сервисов с выделенным ограниченным пулом потоков возможно возникновение ситуации, когда
из-за большого наплыва запросов, используемый пул потоков исчерпывается и сервис вынужден ставить вновь
пришедший запрос в очередь, что так же сказывается на скорости реакции системы.

Одним из возможных способов решения обозначенных проблем является применение <<лёгких>> потоков и написание кода
обработчиков сетевых запросов таким образом, что бы не возникала необходимость производить их синхронизацию.


Наиболее простым и эффективным способом добиться этого -- является применение специализированных библиотек или
систем программирования. Язык программирования ErLang изначально проектировался для решения проблем
многопоточности. А разработанная в его рамках и технология OTP, не только обеспечивает хорошую структурируемость
системы, но и позволяет производить горизонтальное масштабирование всей системы за счёт распределения нагрузки
между несколькими узлами.



\subsubsection{Методика обеспечения отказоустойчивости контролирующего
сервиса}

\subsection{Разработка сервиса обслуживания запросов операторов системы}
В целях обеспечения надёжности функционирования контролирующего сервиса, что обеспечивается его
 изоляцией в локальной сети предприятия, функции предоставления интерфейса пользователя оператора
и обслуживания запросов операторов были реализованы в дополнительном веб-сервисе.

В отличии от контролирующего сервиса, необходимости ограничивать доступ к веб-сервису из внешних
сетей отсутствует, так как он не позволяет осуществлять ни каких деструктивных функций
операторам системы. Его взаимодействие с базой данных состояния системы осуществляется только по чтению,
а все запросы на управляющие устройства проводятся исключительно через контролирующий сервис.

Как и контролирующий сервис, веб-сервис написан на языке программирования ErLang с использованием технологий
OTP. Подход при котором в качестве веб-сервиса используется частная реализация службы, а не готовый веб-сервис
общего назначения, позволяет повысить производительность системы, уменьшить время её отклика, за счёт реализации
только минимально необходимой для функционирования логики.

Веб интерфейс оператора (рис. \ref{img:acsIf}) контролирующего сервиса позволяет использовать в качестве
ПЭВМ контролирующего сервиса практически любой современный компьютер, в том числе планшетные компьютеры, нет-топы.
За счёт этого, возможно сократить количество дополнительного оборудования, необходимого для обслуживания и использования
системы при её внедрении.

\begin{figure}[h]
	\center{\includegraphics[bb=0 0 1200 800, clip, scale=0.4]{acs_if.png}}
	\caption{Интерфейс оператора контролирующего сервиса}
	\label{img:acsIf}
\end{figure}

\subsubsection{Виды доступных операций}
Интерфейс оператора контролирующего сервиса предоставляет следующие функции:
\begin{itemize}
	\item получение списка опрашиваемых коптильных камер;
	\item добавление коптильной камеры в список опроса;
	\item удаление коптильной камеры из списка опроса;
	\item просмотр динамики показателей датчиков;
	\item установка параметров датчиков;
	\item просмотр версии температурной таблицы;
	\item просмотр версии психометрической таблицы;
	\item просмотр списка подзадачь текущей операции;
	\item переход к следующей подзадаче;
	\item остановка выполнения операции;
	\item просмотр журнала выполненных операций.
\end{itemize}

\subsubsection{Методика оптимизации программы обслуживания операторов системы}

При разработке веб-сервиса были использованы следующие методы оптимизации:
\begin{itemize}
	\item веб-сервис на запрос пользователя выдаёт статическую html страницу, таким образом
		в отличии от типового подхода к формированию динамических веб-ориентированных приложений,
		логика веб-сервиса не выполняет динамического формирования страниц по шаблону, а следовательно
		скорость выдачи страницы пользователю ограничена только скорость выполнения дисковых операций чтения;
	\item логика веб-приложения сосредоточена в JavaScript коде статической страницы;
	\item необходимые данные и веб-сервис передаёт приложению в формате JSON,
	что обеспечивает быстрое преобразование типов данных веб-сервиса и веб-приложения;
	\item в качестве базовой JavaScript библиотеки был выбрана бблиотека jQuery 1.4, однако её часть -- JQuery UI
	для построения элементов пользовательского интерфейса не используется, а все необходимые функции реализуется
	в приложении, что позволило сократить объём передаваемых по сети данных.
\end{itemize}


\subsection{Разработка микропрограммы управляющего устройства}

% (http://www.complexdoc.ru/lib/ГОСТ%20Р%208.585-2001)
\subsubsection{Способ расчёта показателей датчиков температур по
ГОСТ Р 208.585-2001}
В качестве температурных датчиков устанавливаемых внутри объекта управления используются
термопары. Принцип получения показания температуры термопар основан на
термоэлектрическом эффекте Зеебека. Когда концы проводника находятся при разных температурах,
между ними возникает разность потенциалов, пропорциональная разности температур.
Коэффициент пропорциональности называют коэффициентом термоэдс.

Способ получения показаний температуры устройством управления универальной
ситемы терморегулирования осован на табличном методе поиска значения.
Основной его недостаток -- необходимость выделения 300 байт памяти микроконтроллера под
таблицу соответствия температуры и текущего показания термоэдс.
Однако он обладает следующими преимуществами:
\begin{itemize}
	\item{} сложность алгоритма вычисления значения температуры линецна и максимально занимает
		900 тактов;
	\item{} таблица соответствия может одновременно кодировать значение термоэдс с поправкой на
		ошибку считанного значения термоэдс, что необходимо выполнять ввиду нелинейной зависимости
		температуры и термоэдс, разброса чувствительности термопар составляющей 10-15\%, ошибки
		вносимой операционным усилителем, ошибки вносимой способом монтажа термопары на печатной плате;
	\item{} отсутствует необходимость использовать прецизионные сопротивления делителя
		напряжения операционного усилителя.
\end{itemize}

Для получения текущего значения температуры используется следующая формула:
\begin{equation}
	T_i = min_{tbl}(Adc(E_i \times{} K_{amp}) > x) 
\end{equation}
\begin{ESKDexplanation}
	\item[где ]{} $K_{amp}$ -- коэффициент усиления операционного уилителя,
	\item{} $E_i$ -- значение термоэдс,
	\item{} $T_i$ -- значение температуры,
	\item{} $Adc()$ -- функция преобразования аналогово сигнала в цифровой.
\end{ESKDexplanation}


Например для термопары типа Т, текущей температуры $1^oC$, $K_{amp}$ равным 100 и опорным напряжением
АЦП микроконтроллера 3.3 В получим:
$E_i = 0.000043$ В. Разрешение АЦП $= \frac{3.3}{2^{12}} = 0.000805$ В. Один градус температуры
кодируется $\frac{E_i \times{} K_{amp}}{\frac{3.3}{2^{12}}} = 5.34 $ значениями
беззнакового пребразования АЦП, а измеряемый диапазон температур составит от $0^oC$ до $862^oC$,
что в 4 раза превышает необходимую разрешающую способность.

\subsubsection{Методика расчёта компенсации холодного спая}
В местах подключения проводников термопары к управляющему устройству возникают дополнительные термоэдс.
В результате их действия на вход измерительной системы фактически поступает сумма сигналов от рабочей
термопары и от <<термопар>>, возникших в местах подключения.

Существуют различные способы избежать этого эффекта. Самым очевидным из них является поддержание
температуры холодного спая постоянной.

В управляющем устройстве используется техника <<компенсации холодного спая>>: температура холодного спая
измеряется датчиком температуры DS18B20, а затем величина термоэдс холодного спая программно
вычитается из сигнала термопары.

Места подключения термопары в управляющем устройстве расположены в непосредственной близости и имеют одинаковую
температуру, то есть находиться в изотермальной зоне. Датчик DS18B20 находиться в этой же зоне. Таким образом,
для компенсации холодного спая перед код чтения температуры с термопар производит чтение паказаний датчика DS18B20,
производит обратное табличное преобразование температуры в величену термоэдс градуированную по пораметрам
аналого-цифрового преобразователя и выполняет вычитание этих значений.

\subsubsection{Алгоритм управления силовой нагрузкой}

\subsubsection{Алгоритм сетевого взаимодействия управляющего устройства
с контолирующим сервером}
Для взаимодействия с контролирующим сервисом устройство управления использует сеть
стандарта Ethernet 802.3. Так как ни сам микроконтроллер at\-x\-mega\-128\-a3, ни микросхема
ecn28j60 не имеют большого буфера хранения входящих и исходящих сетевых пакетов,
было принято решение реализовать сетевое взаимодействие устройства с внешними устройствами
по упрощенной схеме итеративной обработки одного входного и одного выходного сетевого
пакета. Алгоритм сетевого взаимодейcтвия управляющего устройства с контролирующим сервисом представлен
на рисунке \ref{img:devProto}. Из представленного алгоритма видно, что все минимально необходимые
действия для осуществления работы по сети Ethernet 802.3, сосредоточены в одном конечном автомате.

\begin{figure}[h]
	\center{\includegraphics[bb=0 0 45 55, clip, scale=7.0]{dev_proto.png}}
	\caption{Протокол взаимодействия управляющего устройства и контроллирующего сервиса}
	\label{img:devProto}
\end{figure}

Представленный конечный автомат реализует ARP ''How has'' запрос, ARP ''How has'' ответ --
минимально необходимое подмножество функций протокола ARP для работы в сетях Ethernet 802.3.
В качестве транспортного протокола передачи данных было принято решение использовать
протокол UDP, всвязи с ограниченным количетвом оперативной памяти устройства управления, а так же
потому что алгоритм сетевого взаимодействия  предусматривает механизма повторения передачи
потерянных пакетов.

\subsubsection{Протокол взаимодействия управляющего устройства с контролирующим сервисом}

\subsubsection{Методика применения AES шифрования данных передаваемых
контроллирующему сервису}
Одна из порблем решаемых в порцессе разработки сетевого протокола 
взаимодействия управляющего устройства и контроллирующего сервиса
была проблема обеспечения безопасности передаваемых данных.


Конторллирующий сервис определяет, что принятые данные действительны
сравнивая пароль указаный в заголовке сетевого пакета. Однако,
при использования такого подхода, злоумышленник может прослушав
порходящий сетевой трафик получит этот пароль и использовать его
для формирования ложных запросов.


Для того, что бы избежать этого, заголовок пакета, содержащий пароль
и набор аппаратно специфичных данных, должен подвергаться дополнительному
кодированию с ипользованием секретного ключа, известного только
авторизованному устройству и контроллирующему сервису.


В качестве алгоритма кодирования данных заголовка пакета был использован
Advanced Encryption Standard. AES -- симметричный алгоритм блочного
шифрования, принятый в качестве стандарта шифрования правительством США
по результатам конкурса, организованного NIST в 1997 году, для замещения
алгоритма DES.


Причиной выбора именно этого алгоритма кодирования является
наличие аппаратной поддержки AES в микроконтроллерах XMega.


Благодаря наличию этого аппаратного модуля, порцедура кодирования
по алгоритму AES со стороны программного обеспечения микроконтроллера
сводиться к следующим шагам:
\begin{enumerate}
    \item{} Загрузить данные ключа в область памяти $AES.KEY$
        переферийного устройства AES кодирования.
    \item{} Загрузить шифруемые данные в область памяти $AES.STATE$.
    \item{} Установить параметры шифрования и флаг $AES_START_bm$ начала
        процедуры шифрования в конфигурационномй регистре $AES.CTRL$.
    \item{} Дождаться завршения шифрования, о чём сигнализирует
        флаги состояния в регистре состояния $AES.STATUS$.
    \item{} В рависимости от значения статуса, либо считать зашифрованные
        данные из области памяти $AES.STATE$, либо сообщить об ошибке
        шифрования.
\end{enumerate}


\subsubsection{Методика понижения потребляемого тока управляющим устройством
программным способом}

\subsubsection{Описание структуры классов микропрограммы управляющего устройства}

